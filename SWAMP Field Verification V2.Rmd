---
title: "SWAMP Field Measure Verification"
author: "Marc Petta"
date: "January 2018"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
## SWAMP
The SWAMP Field Measurements and Physical Habitat template often requires modification upon reciept. For loading, ensure that the Funding Code worksheet has been added (position sheet = 6) and has appropriate field names. As of November 2018 the current SWAMP Field Loader only accepts xls files; save file format accordingly for loading. 

For using this script ensure the file is saved as xlsx.

ASSUMPTIONS:
What follows assumes that xlsx formatting matches what is generated by the Extraction Tool; assumes all constituents are fixed as of November 2018 and that each analyte has only one unit of measurement; treats all projects equally and consideration should be made whether to apply this to non swamp data.

Please note that this verifies common field measuremets submitted to swamp. New constituents/anlaytes need to be added here when they develop. If the file read here has uncommon or new constituents they will need to be reviewed manually.

```{r}
##########  112118-this code works. Still need to work on calibration date review and clean the code up from comments #########




#install.packages("writexl")
#install.packages("dplyr")

#install.packages("readxl") #used for read_excel but java dependant
#install.packages("openxlsx") does not specify column type
library(dplyr)
#library(readr)
#library(ggformula)
#library(gdata)
library(readxl)
#install.packages(xlsx) #used to write to excel
#library(xlsx)  #this is not being used and will not load 111418
#library(openxlsx) still testing this 
library(writexl)

```

## SWAMP
Whats follows is an automoation of the SWAMP Field Measure Verification method.


```{r}
#Save SWAMP Field Measures and Physical Habitat template to working directory

#Read in the file that is to be verified.
swamp = read_excel("swamp.xlsx", 
                   sheet = "FieldResults",
                   col_types = c("text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "text", "numeric", "numeric", "text", "text", "text", "text", "text", "text", "text", "text", "numeric", "numeric", "text", "text", "text", "text", "text", "text", "text"))

#Transform col types as date time 
mutate(swamp, SampleDate= as.Date(SampleDate, format= "%d.%m.%Y"))
mutate(swamp, CalibrationDate= as.Date(CalibrationDate, format= "%d.%m.%Y"))

#this is not working because i believe the dates are still formatted as char. TRY using %--% operator
#swamp$cal_dif <- as.Date(as.character(swamp$CalibrationDate), format="%d.%m.%Y")-as.Date(as.character(swamp$SampleDate), format="%d.%m.%Y")
#swamp$cal_dif <- as.difftime(c(as.POSIXct(swamp$CalibrationDate), as.POSIXct(swamp$SampleDate)))
#swamp@cal_diff <- with(swamp, ifelse(CalibrationDate > SampleDate, "QAORR", "" ))

mutate(swamp, CollectionTime= as.Date(CollectionTime, format= "%H:%M:%S"))
#Review to ensure the data frame has the appropriate headers and formatted correctly. 


###TRYING TO SET ALL THE NULL VALUES IN RESULTS ENDS UP BREAKING THE WHOLE THING
#swamp$Result[is.na(swamp$Result)] <- "NR"

head(swamp)
```


```{r}
#Result == NULL ~ "QAORR",

swamp1 <-
  swamp %>%
  mutate(ComplianceCode = case_when( 
    AnalyteName == "Alkalinity as CaCO3" & Result < 0 ~ "QAORR",
    AnalyteName == "Alkalinity as CaCO3" & Result > 500 ~ "QAORR",
    AnalyteName == "Chlorophyll a" & Result < 0 ~ "QAORR",
    AnalyteName == "Chlorophyll a" & Result > 15 ~ "QAORR",
    AnalyteName == "Discharge" & Result < 0 ~ "QAORR",
    AnalyteName == "Discharge" & Result > 1000 ~ "QAORR",
    AnalyteName == "ElectricalConductivity" & Result < 0 ~ "QAORR",
    AnalyteName == "ElectricalConductivity" & Result > 2000 ~ "QAORR",
    AnalyteName == "Oxygen, Saturation" & Result < 0 ~ "QAORR",
    AnalyteName == "Oxygen, Saturation" & Result > 175 ~ "QAORR",
    AnalyteName == "Oxygen, Dissolved" & Result < 0 ~ "QAORR",
    AnalyteName == "Oxygen, Dissolved" & Result > 20 ~ "QAORR",
    AnalyteName == "pH" & Result < 4 ~ "QAORR",
    AnalyteName == "pH" & Result > 8 ~ "QAORR",
    AnalyteName == "Salinity" & Result < 0 ~ "QAORR",
    AnalyteName == "Salinity" & Result > 34 ~ "QAORR",
    AnalyteName == "Silica as SiO2" & Result < 0 ~ "QAORR",
    AnalyteName == "Silica as SiO2" & Result > 100 ~ "QAORR",
    AnalyteName == "SpecificConductivity" & Result < 0 ~ "QAORR",
    AnalyteName == "SpecificConductivity" & Result > 2000 ~ "QAORR",
    AnalyteName == "Temperature" & MatrixName == "air" & Result < -10 ~ "QAORR",
    AnalyteName == "Temperature" & MatrixName == "air" & Result > 45 ~ "QAORR",
    AnalyteName == "Temperature" & MatrixName == "samplewater" & Result < 0 ~ "QAORR",
    AnalyteName == "Temperature" & MatrixName == "samplewater" & Result > 25 ~ "QAORR",
    AnalyteName == "Turbidity" & Result < -5 ~ "QAORR",
    AnalyteName == "Turbidity" & Result > 350 ~ "QAORR",
    AnalyteName == "Velocity" & Result < -10 ~ "QAORR",
    AnalyteName == "Velocity" & Result > 75 ~ "QAORR",
    
   # AnalyteName == "Oxygen, Dissolved" & CalibrationDate - SampleDate > 1 ~ "QAORR",
    
   #This does not work. i am trying to create a new field (line 56) that will be difference in dates.That way i can use the same type thing as above 
     #mutate(ComplianceCode = as.factor(ifelse(AnalyteName = "Oxygen, Dissolved" & CalibrationDate - SampleDate > 1, "QAORR", ComplianceCode))) %>%
    
    TRUE ~ "Com"
  ))


  #looks at QACode and returns QAORR if value other than None
swamp2 <-
  swamp1 %>%
  mutate(ComplianceCode = as.factor(ifelse(QACode == "None", ComplianceCode, "QAORR"))) %>%
  mutate(BatchVerificationCode = as.factor(ifelse(ComplianceCode == "Com", "VAC", "NA" ))) %>%
  mutate(ResQualCode = as.character(ifelse(Result == "", "NR", ResQualCode)))


##I WILL NEED A SIMILAR IFELSE STATEMENT FOR CALIBRATION DATE IF CALD IS GREATER THAN SAMPLED QAORR

  #mutate(LeatherMod = as.factor(ifelse(Leather == 1, "Yes", "No")))
#View(swamp2)
```

The output of the following is to be reviewed and imported into the final template for loading.
The result of this will require that all ComplianceCodes, ResQualCodes, and QACodes are finalized according to SWAMP business rules before loading.

```{r}

#write.xlsx(swamp2, "RWB2_Shell_2018_0710_WQ_WriteTest", sheetName="FieldResult",
  #col.names=TRUE, row.names=FALSE, append=TRUE)

write_xlsx(swamp2, "SWAMP_WrtiteTest.xlsx", col_names = TRUE)


```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
